# 要件定義書：画像ウォーターマークWebサービス

## 1. 背景・目的

- **背景**：ブロガー、Webデザイナー、コンテンツクリエイターが画像の不正コピー防止のために手動でウォーターマークを挿入する手間を省きたいというニーズがある。
- **背景**：ユーザーが複数のJPEG画像に一括でウォーターマークを挿入し、まとめてダウンロードできるWebサービスの需要が高まっている。
- **目的**：直感的なブラウザUIで設定を行い、自動でウォーターマーク加工・一括ダウンロードを実現する。

## 2. 対象範囲## 2. 対象範囲

- 対象ファイル：拡張子「.jpg」「.jpeg」のみ
- ユーザー情報：DBには保持せず、認証情報のみDBで管理
- 環境：Vercelへのデプロイ、Neon PostgreSQL（無料プラン）を認証に利用

## 3. 機能要件

### 3.1 画像アップロード

- ドラッグ＆ドロップ、およびファイルダイアログ対応
- 同時選択：複数ファイル
- 拡張子チェック（.jpg/.jpeg以外は拒否）

### 3.2 ウォーターマーク設定

ブラウザ上で以下パラメータを入力

```
・フォントの種類（商用利用可フォントを選択）
・フォントサイズ
・ウォーターマークテキスト
・挿入位置（上部/中央/下部）
・ウォーターマーク透明度
・影のオフセット（X, Y）
・影の有効・無効
・影の透明度
```

### 3.3 ウォーターマーク適用＆一括ダウンロード

- 「実行」ボタンで全画像を加工
- 加工後の画像をZIP化し、ユーザーへダウンロード提供

### 3.4 設定ファイルの保存・読み込み

- 加工パラメータをJSON形式でローカル保存
- 保存済みJSONをアップロードすると、UIに設定を復元

### 3.5 認証

- **ユーザー認証**：月次招待コード（YYYYMM-XXXXX形式）
- **有効期間**：当月末まで（時間制限なし）
- **管理者認証**：固定ID・パスワード、JWT（24時間有効）
- 認証結果はNeon PostgreSQLで確認

### 3.6 管理者機能

- **管理画面**：招待コード生成・管理、使用統計表示
- **認証方式**：固定ID・パスワード（環境変数管理）
- **Slack通知**：新コード生成時の自動通知（Webhook URL暗号化保存）

### 3.7 同時処理制御

- **キューシステム**：1ユーザーのみ処理、他は順番待ち
- **待機表示**：「順番待ち中... あと○人待ちです」
- **タイムアウト**：10分で自動解放

## 4. 非機能要件

### 4.1 パフォーマンス・制限

- **ファイル制限**：1ファイル3MB以下、最大5ファイル、総計15MB以下
- **処理方式**：ハイブリッド自動振り分け
  - 軽量処理（1ファイル1.5MB以下）：Canvas API（クライアント）
  - 重量処理（2-5ファイル）：Sharp + Node.js（サーバー）
- **同時処理**：1ユーザーのみ、他はキュー待機（最大5人、10分タイムアウト）

### 4.2 ダウンロード方式

- **自動判定**：処理後ファイルサイズが4MB以下はZIP、超過時は個別ダウンロード
- **ZIP圧縮エラー対策**：メモリ監視、フォールバック機能

### 4.3 可用性・セキュリティ

- **可用性**：Vercelの無料プラン範囲で稼働
- **セキュリティ**：HTTPS必須、認証・パスワードはハッシュ化して保存
- **スケーラビリティ**：サーバーレス関数のコールドスタート時間を考慮

## 5. 技術要件

- **フロントエンド**：React/Vue.js等によるSPA
  - 画像加工：HTML5 CanvasまたはWebAssembly版ImageMagickライブラリ
  - ZIP生成：JSZipなどのライブラリ
- **バックエンド**：Vercel Serverless Functions
  - 認証API（Neon PostgreSQL）
  - 必要に応じてサーバーサイドでの画像加工・ZIP生成
- **DB**：Neon PostgreSQL（無料プラン）
- **デプロイ**：Vercel CLIによる自動デプロイ

> **注意事項：フォントファイルの事前取得**
>
> - 商用利用可能なフォントファイルを利用する場合、対象フォントのライセンス確認とファイル取得先（例：Google Fontsや有償フォント提供元）を事前にプロジェクトチームへ提供し、配置方法を要望仕様として明示してください。

## 6. 技術的検討・懸念事項. 技術的検討・懸念事項

- **ブラウザ処理限界**：大量または高解像度画像をCanvasで扱うとメモリ不足や動作遅延の可能性あり。サーバーサイド処理が必要になる場合がある。
- **ZIP生成の負荷**：JSZipでの大量ファイル圧縮はCPU負荷・メモリ消費が大きく、タイムアウトリスクあり。バックエンド処理への切り替え検討。
- **Neon PostgreSQL接続制限**：無料プランでは同時接続数やクエリ数に制限があるため、認証APIのキャッシュやプール導入が必要。
- **File System Access API対応状況**：ローカルファイル保存・読み込み機能はブラウザ依存。対応ブラウザの限定やフォールバック機能の実装が必要。
- **フォントライセンス管理**：商用利用フォントをCDN配布する場合、ライセンス遵守と配布方法に注意。

## 7. 運用・保守

- **ログ管理**：エラーログのみVercelログ機能を利用。個人情報は収集しない。
- **障害対応**：Vercelのステータス監視、DB接続異常のアラート設定
- **バージョン管理**：GitHub連携、自動デプロイ

## 8. UI/UX要件

- レスポンシブ対応（PC/Mobile）
- アップロード進捗表示
- エラー／完了メッセージの明確化
- アクセシビリティ（キーボード操作、ARIA属性）

### 8.1 エラーハンドリング

- **主要エラー**：ファイル、画像処理、認証、キュー、ダウンロード
- **表示方針**：ユーザーフレンドリー、復旧方法明示、部分失敗継続

---

*以上の要件をもとに実装担当者は詳細設計へ進んでください。*

## 9. 実装順序

### Phase 1: 基盤構築（優先度：高）
1. データベーススキーマ設計・作成
2. 基本認証API（招待コード認証）
3. 簡単なフロントエンド認証画面

### Phase 2: 管理機能（優先度：高）
4. 管理者認証API
5. 管理画面UI（コード生成・統計）
6. Slack通知機能

### Phase 3: コア機能（優先度：高）
7. ファイルアップロード機能
8. 軽量処理（Canvas API）実装
9. 基本的なウォーターマーク適用
10. 個別ダウンロード機能

### Phase 4: 拡張機能（優先度：中）
11. 重量処理（Sharp）実装
12. ZIP一括ダウンロード
13. 自動振り分けロジック
14. 設定ファイル保存・読み込み

### Phase 5: 品質向上（優先度：中）
15. キューシステム・同時処理制御
16. エラーハンドリング強化
17. プログレスバー・UI改善

**開始推奨**: データベーススキーマから実装開始

## 10. GitHub Repository

- **Repository Name**: `image-watermark-web-service`

