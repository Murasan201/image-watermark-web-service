# 要件定義書：画像ウォーターマークWebサービス

## 1. 背景・目的

- **背景**：ブロガー、Webデザイナー、コンテンツクリエイターが画像の不正コピー防止のために手動でウォーターマークを挿入する手間を省きたいというニーズがある。
- **背景**：ユーザーが複数のJPEG画像に一括でウォーターマークを挿入し、まとめてダウンロードできるWebサービスの需要が高まっている。
- **目的**：直感的なブラウザUIで設定を行い、自動でウォーターマーク加工・一括ダウンロードを実現する。

## 2. 対象範囲## 2. 対象範囲

- 対象ファイル：拡張子「.jpg」「.jpeg」のみ
- ユーザー情報：DBには保持せず、認証情報のみDBで管理
- 環境：Vercelへのデプロイ、Neon PostgreSQL（無料プラン）を認証に利用

## 3. 機能要件

### 3.1 画像アップロード

- ドラッグ＆ドロップ、およびファイルダイアログ対応
- 同時選択：複数ファイル
- 拡張子チェック（.jpg/.jpeg以外は拒否）

### 3.2 ウォーターマーク設定

ブラウザ上で以下パラメータを入力

```
・フォントの種類（商用利用可フォントを選択）
  - システムフォント: Arial, Georgia, Times New Roman, Helvetica
  - Google Fonts: Noto Sans JP（日本語推奨）, Roboto（シンプル・現代的）, Open Sans（見やすい・クリア）
・フォントサイズ（12-500px、スマートステップ対応）
・ウォーターマークテキスト
・挿入位置（左上/右上/中央/左下/右下）
・ウォーターマーク透明度
・テキスト色（カラーピッカー対応）
・影のオフセット（X, Y）
・影の有効・無効
・影の透明度
```

### 3.3 ウォーターマーク適用＆一括ダウンロード

- 「実行」ボタンで全画像を加工
- 加工後の画像をZIP化し、ユーザーへダウンロード提供

### 3.4 再処理機能（Phase 3で追加実装）

- **元画像保持**: 処理後も元画像をメモリ内で保持
- **パラメータ変更後の再適用**: 再アップロード不要で設定変更・再処理可能
- **表示切替機能**: 元画像/処理済み画像の切替表示
- **自動振り分け対応**: 再処理時もファイルサイズに応じて最適な処理方式を選択

### 3.5 設定ファイルの保存・読み込み

- 加工パラメータをJSON形式でローカル保存
- 保存済みJSONをアップロードすると、UIに設定を復元

### 3.6 認証

#### ユーザー認証（サブスクリプション契約者）
- **月次招待コード**：YYYYMM-XXXXX形式（例: 202506-A7B9C）
  - 有効期間：当月末まで（時間制限なし）
  - 対象：一般サブスクリプション契約者
- **個別ユーザーキー**：USER-XXXXX形式（例: USER-H3K9M）
  - 有効期間：管理者指定期間（7日〜3650日）
  - 対象：特定ユーザー向けカスタム期間
  - ユーザー名・用途説明の記録可能
- **管理者認証**：固定ID・パスワード、JWT（24時間有効）
- 認証結果はNeon PostgreSQLで確認

### 3.7 管理者機能

#### 招待コード管理
- **月次コード生成**：年月指定による月次招待コード生成
- **個別ユーザーキー生成**：
  - ユーザー名・用途説明・有効期限日数の指定
  - カスタム期間設定（7日〜3650日）
  - 個別管理とトラッキング
- **コード管理機能**：
  - 招待コード一覧表示（月次・個別キー統合表示）
  - コード無効化機能
  - 期限切れコード削除機能（個別・一括）
  - 使用統計表示（使用回数・アクティブセッション数）

#### システム管理
- **認証方式**：固定ID・パスワード（環境変数管理）
- **Slack通知**：新コード生成時の自動通知（月次・個別キー両対応）
  - Webhook URL暗号化保存
  - リッチテキスト形式通知
- **デバッグ機能**：API通信詳細表示パネル（常時利用可能）

### 3.8 同時処理制御

- **キューシステム**：1ユーザーのみ処理、他は順番待ち
- **待機表示**：「順番待ち中... あと○人待ちです」
- **タイムアウト**：10分で自動解放

### 3.9 超高解像度対応（Phase 4で追加実装）

- **大幅なフォントサイズ拡張**: 12-72px → 12-500px
- **スマートステップ調整**: サイズ範囲に応じた最適な刻み幅
  - 12-50px: 1px刻み（細かい調整）
  - 50-100px: 2px刻み（標準）
  - 100-200px: 5px刻み（大きいサイズ）
  - 200-500px: 10px刻み（超大サイズ）
- **視覚的ガイド**: 解像度レベルに応じたヒント表示
- **高解像度画像対応**: 2MB超の大容量画像でも視認可能なウォーターマーク

## 4. 非機能要件

### 4.1 パフォーマンス・制限

- **ファイル制限**：1ファイル3MB以下、最大5ファイル、総計15MB以下
- **処理方式**：クライアントサイド統一処理（2025年6月更新）
  - **全ファイル処理**：Canvas API（クライアント）による統一処理
  - **旧サーバー処理**：Sharp + Node.js（廃止済み - 2025年6月21日）
  - **廃止理由**：Vercel環境でのFontconfig問題、位置ずれ・文字化け対策
- **同時処理**：1ユーザーのみ、他はキュー待機（最大5人、10分タイムアウト）

### 4.2 ダウンロード方式

- **自動判定**：処理後ファイルサイズが4MB以下はZIP、超過時は個別ダウンロード
- **ZIP圧縮エラー対策**：メモリ監視、フォールバック機能

### 4.3 可用性・セキュリティ

- **可用性**：Vercelの無料プラン範囲で稼働
- **セキュリティ**：HTTPS必須、認証・パスワードはハッシュ化して保存
- **スケーラビリティ**：サーバーレス関数のコールドスタート時間を考慮

## 5. 技術要件

- **フロントエンド**：React/Next.js によるSPA
  - 画像加工：HTML5 Canvas API（統一処理）
  - ZIP生成：JSZipライブラリ
- **バックエンド**：Vercel Serverless Functions
  - 認証API（Neon PostgreSQL）
  - キューシステム・セッション管理
  - ~~サーバーサイド画像加工~~（廃止済み - 2025年6月21日）
- **DB**：Neon PostgreSQL（無料プラン）
- **デプロイ**：Vercel CLIによる自動デプロイ

### 5.1 フォント実装状況（2025年6月更新）

#### システムフォント（ブラウザ標準）
- **Arial, Georgia, Times New Roman, Helvetica**: Canvas API経由で安全に利用可能
- **商用利用**: ブラウザ経由でのシステムフォント参照は合法的使用

#### Google Fonts実装（next/font/google）
- **Noto Sans JP**: 日本語フォント、Open Font License
- **Roboto**: モダンサンセリフ、Open Font License  
- **Open Sans**: 高い可読性、Open Font License
- **ライセンス**: すべてGoogle Fonts（Open Font License）で商用利用可能
- **実装**: Next.js 14のnext/font/googleによる最適化読み込み
- **ユーザビリティ**: 日本語ユーザー向けに分かりやすいラベル表示

#### フォント選択肢の改善履歴
```
2025年6月21日更新:
- 「Roboto（モダンサンセリフ）」→「Roboto（シンプル・現代的）」
- 「Open Sans（読みやすいサンセリフ）」→「Open Sans（見やすい・クリア）」
- 理由: 日本のユーザーにとってより分かりやすい表現に変更
```

## 6. 技術的検討・懸念事項

### 6.1 現在の懸念事項
- **ブラウザ処理限界**：15MB以上の大量画像処理時にメモリ不足の可能性。現在の制限内（15MB以下）では問題なし。
- **ZIP生成の負荷**：JSZipでの大量ファイル圧縮はCPU負荷・メモリ消費が大きく、タイムアウトリスクあり。4MB超過時は個別ダウンロードで対応済み。
- **Neon PostgreSQL接続制限**：無料プランでは同時接続数やクエリ数に制限があるため、認証APIのキャッシュやプール導入が必要。
- **File System Access API対応状況**：ローカルファイル保存・読み込み機能はブラウザ依存。対応ブラウザの限定やフォールバック機能の実装が必要。

### 6.2 解決済み懸念事項（2025年6月21日更新）
- ~~**サーバーサイド処理のFontconfig問題**~~：**解決済み** - クライアントサイド統一処理により完全回避
- ~~**複数ファイル処理時の位置ずれ・文字化け**~~：**解決済み** - Canvas API統一により根本解決
- ~~**Vercel環境でのSharp・SVG処理不安定性**~~：**解決済み** - サーバーサイド処理廃止により回避
- ~~**環境依存によるフォント描画エラー**~~：**解決済み** - ブラウザ標準フォントのみ使用

## 7. 運用・保守

- **ログ管理**：エラーログのみVercelログ機能を利用。個人情報は収集しない。
- **障害対応**：Vercelのステータス監視、DB接続異常のアラート設定
- **バージョン管理**：GitHub連携、自動デプロイ

## 8. UI/UX要件

- レスポンシブ対応（PC/Mobile）
- アップロード進捗表示
- エラー／完了メッセージの明確化
- アクセシビリティ（キーボード操作、ARIA属性）

### 8.1 エラーハンドリング

- **主要エラー**：ファイル、画像処理、認証、キュー、ダウンロード
- **表示方針**：ユーザーフレンドリー、復旧方法明示、部分失敗継続

---

*以上の要件をもとに実装担当者は詳細設計へ進んでください。*

## 9. 実装順序

### Phase 1: 基盤構築（優先度：高）
1. データベーススキーマ設計・作成
2. 基本認証API（招待コード認証）
3. 簡単なフロントエンド認証画面

### Phase 2: 管理機能（優先度：高）
4. 管理者認証API
5. 管理画面UI（コード生成・統計）
6. Slack通知機能

### Phase 3: コア機能（優先度：高）
7. ファイルアップロード機能
8. 軽量処理（Canvas API）実装
9. 基本的なウォーターマーク適用
10. 個別ダウンロード機能

### Phase 4: 拡張機能（優先度：中）
11. 重量処理（Sharp）実装
12. ZIP一括ダウンロード
13. 自動振り分けロジック
14. 設定ファイル保存・読み込み

### Phase 5: 品質向上（優先度：中）
15. キューシステム・同時処理制御
16. エラーハンドリング強化
17. プログレスバー・UI改善

**開始推奨**: データベーススキーマから実装開始

## 10. GitHub Repository

- **Repository Name**: `image-watermark-web-service`

