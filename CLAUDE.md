# 画像ウォーターマークWebサービス - 開発ガイド

## プロジェクト概要
画像にウォーターマークを一括適用し、ZIP形式でダウンロードできるWebサービス

## 要件定義書
- **要件定義書**: `image-watermark-web-service-spec.md`
- このファイルにプロジェクトの全要件が記載されています
- 実装前に必ず要件定義書を参照してください

## 技術スタック
- **フロントエンド**: React/Vue.js (SPA)
- **バックエンド**: Vercel Serverless Functions  
- **データベース**: Neon PostgreSQL (認証のみ)
- **デプロイ**: Vercel
- **画像処理**: HTML5 Canvas または WebAssembly版ImageMagick
- **ZIP生成**: JSZip

## 主要機能
1. 画像アップロード (.jpg/.jpeg のみ)
2. ウォーターマーク設定 (テキスト、フォント、位置、透明度等)
3. 一括処理・ZIP ダウンロード
4. 設定ファイル保存・読み込み (JSON)
5. 認証機能

## 開発ルール
- 対象ファイル: .jpg/.jpeg のみ
- セキュリティ: HTTPS必須、パスワードはハッシュ化
- レスポンシブ対応必須
- アクセシビリティ対応必須

## 認証システム

### ユーザー認証（サブスクリプション契約者）
- **方式**: 月次招待コード認証（サブスクリプション契約者限定）
- **コード形式**: YYYYMM-XXXXX（例: 202501-A7B9C）
- **有効期間**: 当月末まで（時間制限なし）
- **セッション**: コード認証後は月末まで継続
- **管理**: 管理画面 + Slack通知の両方で運用
- **データベース**: invitation_codes, user_sessions テーブル

### 管理者認証
- **方式**: 固定ID・パスワード認証（環境変数管理）
- **管理者**: 単一管理者のみ
- **セッション**: JWT トークン（24時間有効）
- **URL**: `/admin` 配下
- **環境変数**: 
  - `ADMIN_USERNAME` : 管理者ID
  - `ADMIN_PASSWORD_HASH` : bcryptハッシュ値
  - `JWT_SECRET` : JWT署名用シークレット
- **データベース**: admin_sessions テーブル

## Slack通知システム
- **通知タイミング**: 新コード生成時のみ
- **保存方式**: Webhook URL を暗号化してDB保存
- **設定方法**: 管理画面でWebhook URL入力
- **通知内容**: 
  - 生成されたコード
  - 有効期限
  - 使用回数（0回）
  - 管理画面リンク
- **セキュリティ**: 
  - URL形式検証
  - 送信頻度制限（1分間10回）
  - リトライ制限（3回まで）
- **環境変数**: `ENCRYPT_KEY` （暗号化キー）
- **データベース**: admin_settings テーブル

## ファイルサイズ・処理制限
### Vercel Function制限準拠
- **1ファイル**: 3MB以下
- **同時処理**: 最大5ファイル
- **総計**: 15MB以下/リクエスト
- **同時ユーザー**: 1ユーザーのみ処理、他はキュー待機

### 処理方式：ハイブリッド自動振り分け
- **基本方針**: 運用コスト最適化を優先した自動振り分け
- **データ保持**: インメモリ処理（外部ストレージなし）
- **離脱対策**: プログレスバー、離脱防止メッセージ
- **キュー管理**: 最大5人待機、10分タイムアウト

#### クライアント処理（Canvas API）
```
条件: 1ファイル かつ 1.5MB以下
処理時間: 約1-5秒
使用技術: HTML5 Canvas API（無料）
メリット: サーバーリソース消費ゼロ、高速レスポンス
```

#### サーバー処理（Sharp + Node.js）
```
条件: 2-5ファイル かつ 総計15MB以下
処理時間: 約5-10秒
使用技術: Sharp（Node.js）
メリット: 高品質処理、メモリ効率
```

#### 振り分けロジック
```javascript
function determineProcessingMethod(files) {
  const totalSize = files.reduce((sum, file) => sum + file.size, 0);
  const fileCount = files.length;
  
  // Canvas API（快適処理）
  if (fileCount === 1 && files[0].size <= 1.5 * 1024 * 1024) {
    return 'CLIENT';
  }
  
  // Server処理
  if (fileCount <= 5 && totalSize <= 15 * 1024 * 1024) {
    return 'SERVER';
  }
  
  return 'ERROR';
}
```

### クリーンアップ
- 処理中データ: 30分でタイムアウト
- 異常終了セッション: 自動解放
- cron実行: 毎時実行

## ダウンロード方式
### 自動判定ロジック
```javascript
function determineDownloadMethod(processedFiles) {
  const totalSize = processedFiles.reduce((sum, file) => sum + file.size, 0);
  
  // ZIP一括ダウンロード（4MB以下）
  if (totalSize <= 4 * 1024 * 1024) {
    return 'ZIP';
  }
  
  // 個別ダウンロード（4MB超過）
  return 'INDIVIDUAL';
}
```

### ZIP圧縮エラー対策
- **エラーケース**: メモリ不足、圧縮タイムアウト、ZIP生成失敗
- **対策**: 
  - 圧縮前のサイズチェック
  - メモリ使用量監視
  - フォールバック（個別ダウンロード）
  - ユーザーへの明確なエラーメッセージ

## エラーハンドリング
### 主要エラーケース
- **ファイルアップロード**: 拡張子・サイズ・破損ファイル
- **画像処理**: Canvas APIエラー、処理タイムアウト
- **認証**: 無効コード、セッション切れ、DB接続エラー
- **キュー**: 満杯、異常終了、リソース不足
- **ダウンロード**: ZIP圧縮失敗、ファイル破損

### エラー表示方針
- ユーザーフレンドリーなメッセージ
- 技術的詳細は隠す
- 復旧方法の明示
- 部分失敗時の継続処理

## 注意事項
- 商用利用可能フォントのライセンス確認必須
- ブラウザ処理限界を考慮したサーバーサイド処理の検討
- Neon PostgreSQL無料プランの制限に注意

## 要件定義書への追記内容

### 3.6 管理者機能
- **管理画面**：招待コード生成・管理、使用統計表示
- **認証方式**：固定ID・パスワード（環境変数管理）
- **Slack通知**：新コード生成時の自動通知（Webhook URL暗号化保存）

### 3.7 同時処理制御
- **キューシステム**：1ユーザーのみ処理、他は順番待ち
- **待機表示**：「順番待ち中... あと○人待ちです」
- **タイムアウト**：10分で自動解放

### 4.1 パフォーマンス・制限（更新）
- **ファイル制限**：1ファイル3MB以下、最大5ファイル、総計15MB以下
- **処理方式**：ハイブリッド自動振り分け
  - 軽量処理（1ファイル1.5MB以下）：Canvas API（クライアント）
  - 重量処理（2-5ファイル）：Sharp + Node.js（サーバー）
- **同時処理**：1ユーザーのみ、他はキュー待機（最大5人、10分タイムアウト）

### 4.2 ダウンロード方式（新規）
- **自動判定**：処理後ファイルサイズが4MB以下はZIP、超過時は個別ダウンロード
- **ZIP圧縮エラー対策**：メモリ監視、フォールバック機能

### 3.5 認証（更新）
- **ユーザー認証**：月次招待コード（YYYYMM-XXXXX形式）
- **有効期間**：当月末まで（時間制限なし）
- **管理者認証**：固定ID・パスワード、JWT（24時間有効）

### 8.1 エラーハンドリング（新規）
- **主要エラー**：ファイル、画像処理、認証、キュー、ダウンロード
- **表示方針**：ユーザーフレンドリー、復旧方法明示、部分失敗継続

## 実装順序

### Phase 1: 基盤構築（優先度：高）
1. データベーススキーマ設計・作成
2. 基本認証API（招待コード認証）
3. 簡単なフロントエンド認証画面

### Phase 2: 管理機能（優先度：高）
4. 管理者認証API
5. 管理画面UI（コード生成・統計）
6. Slack通知機能

### Phase 3: コア機能（優先度：高）
7. ファイルアップロード機能
8. 軽量処理（Canvas API）実装
9. 基本的なウォーターマーク適用
10. 個別ダウンロード機能

### Phase 4: 拡張機能（優先度：中）
11. 重量処理（Sharp）実装
12. ZIP一括ダウンロード
13. 自動振り分けロジック
14. 設定ファイル保存・読み込み

### Phase 5: 品質向上（優先度：中）
15. キューシステム・同時処理制御
16. エラーハンドリング強化
17. プログレスバー・UI改善

**開始**: データベーススキーマから実装開始

## 実装進捗状況

### ✅ Phase 1: 基盤構築（完了）
- ✅ **1. データベーススキーマ設計・作成** 
  - Neonデータベース作成完了
  - 5つのテーブル作成完了 (invitation_codes, user_sessions, admin_sessions, admin_settings, processing_queue)
  - インデックス・初期データ投入完了
  - スキーマSQL実行完了
- ✅ **2. 基本認証API（招待コード認証）** 
  - Vercel環境変数設定完了（DATABASE_URL配置済み）
  - データベース接続確認済み
  - 認証API実装完了（/api/auth/verify, /api/auth/session）
  - ライブラリ関数実装完了（src/lib/auth.ts, src/lib/database.ts）
- ✅ **3. 簡単なフロントエンド認証画面** 
  - React認証フォーム実装完了（src/app/auth/page.tsx）
  - セッション管理機能実装完了（src/app/page.tsx）
  - ルート保護ミドルウェア実装完了（src/middleware.ts）

### ✅ Phase 1 テスト・デバッグ完了
- ✅ **認証システムの動作確認**
  - サンプル招待コード「202501-SAMPLE」での認証テスト成功
  - データベース接続・セッション管理の動作確認完了
  - 入力値検証（フロントエンド・API）の調整完了
  - 有効期限切れコードの修正対応完了

### ⏳ Phase 2: 管理機能（次回実装予定）
- ⏳ 4. 管理者認証API
- ⏳ 5. 管理画面UI（コード生成・統計）
- ⏳ 6. Slack通知機能

### ⏳ Phase 3-5: 後続フェーズ（未着手）

### 📝 完了済み作業（2025/6/16）
- プロジェクト基本構成（Next.js + TypeScript + Tailwind）
- データベース設計・作成・接続
- 認証システムの完全実装（フロントエンド・バックエンド）
- Gitリポジトリ管理・Vercelデプロイ
- **実際の動作テスト完了** - ユーザーが正常にログイン可能な状態

### 🛠️ 実装詳細
#### データベーステーブル
```sql
invitation_codes   - 招待コード管理
user_sessions     - ユーザーセッション管理  
admin_sessions    - 管理者セッション管理
admin_settings    - 管理者設定（Slack Webhook等）
processing_queue  - 処理キュー管理
```

#### API エンドポイント
```
POST /api/auth/verify     - 招待コード認証
GET  /api/auth/session    - セッション確認
DELETE /api/auth/session  - ログアウト
GET  /api/debug          - デバッグ情報取得（開発用）
POST /api/update-sample   - サンプルコード更新（保守用）
```

#### フロントエンドページ
```
/              - メインページ（認証後）
/auth          - 認証フォーム
/admin/*       - 管理画面（Phase 2で実装予定）
```

### 🔍 トラブルシューティング記録
1. **招待コード入力長制限** - maxLength修正（12→20文字）
2. **API正規表現パターン** - 固定長{5}を可変長+に修正
3. **有効期限切れ** - 2025年1月→6月への更新対応
4. **ミドルウェア保護** - デバッグエンドポイントの公開設定

### 📋 次回作業予定（Phase 2）
1. 管理者認証システムの実装
   - 環境変数設定（ADMIN_USERNAME, ADMIN_PASSWORD_HASH, JWT_SECRET）
   - JWT認証API作成（/api/admin/auth）
   - 管理者専用ミドルウェア追加
2. 管理画面UIの実装
   - 招待コード生成機能
   - 使用状況統計表示
   - Slack Webhook設定画面
3. Slack通知機能の実装
   - Webhook URL暗号化保存
   - 新コード生成時の自動通知

### 🚀 デプロイ情報
- **本番URL**: https://image-watermark-web-service.vercel.app
- **認証**: サンプルコード「202501-SAMPLE」で動作確認済み
- **リポジトリ**: https://github.com/Murasan201/image-watermark-web-service